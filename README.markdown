Java Yandex.Money API SDK
=========================

В библиотеке реализованы вызовы следующих функций API Яндекс.Денег: 

* прохождение OAuth-аутентификации, 
* информация о счете, 
* история операций и детальная информация по ним, 
* переводы денег другим пользователям, 
* оплата в магазины. 

Библиотека представляет собой package `ru.yandex.money.api`, который содержит:

* программный интерфейс `YandexMoney`; 
* реализацию интерфейса `YandexMoneyImpl`;
* классы-перечисления;
* вспомогательные классы (response-объекты вывода результатов запросов к API);
* исключения.

*Внимание:* использует библиотеки Gson (http://sites.google.com/site/gson/) для работы с json и  Apache HTTP client версии 4 (http://hc.apache.org/httpcomponents-client-ga/index.html). Библиотека разрабатывалась и запускалась на Java 6.

Основные методы интерфейса YandexMoney
--------------------------------------

* `authorizeUri` — метод для получения URI, по которому нужно переидти для инициации OAuth-авторизации.
На вход принимает список прав доступа и URI редиректа после авторизации.
Возвращает URI OAuth-авторизации

* `receiveOAuthToken` — метод для обмена временного кода, полученного от сервера Яндекс.Денег после вызова метода authorize, на постоянный токен доступа к счету пользователя. 
На вход принимает временный код.
Возвращает экземпляр класса ReceiveOAuthTokenResponse, содержащий токен или ошибку.

* `accountInfo` — метод для получения информации о счете пользователя.
На вход принимает токен пользователя.
Возвращает экземпляр класса AccountInfoResponse, который содержит поля: номер счета, баланс, валюта счета.

* `operationHistory` — метод для получения истории операций пользователя. 
На вход принимает токен пользователя, номер первой записи (постраничный вывод), количество операций и тип операций (приход или расход).
Возвращает экземпляр класса operationHistoryResponse, который содержит код ошибки, если таковая произошла, номер записи следующей страницы, если таковая есть (постраничный вывод) и коллекцию операций. Операции представляют собой объект Operation (сумма, время, и комментарии к операции).

* `operationDetail` — метод для получения детальной информации по операции из истории или платежей.
На вход принимает токен пользователя и идентификатор операции.
Возвращает экземпляр класса OperationDetailResponse, который унаследован от объекта Operation и предоставляет расширенную информацию по платежу/зачислению.

* `requestPaymentP2P` — метод перевода средств на счет другого пользователя. 
На вход принимает токен пользователя, номер счета (или привязанного телефона) назначения, сумму и комментарий.
Возврашает экземпляр класса RequestPaymentResponse, который содержит ошибку, если таковая произошла, информацию о статусе операции, идентификатор операции, контракт и баланс.

* `requestPaymentShop` — метод оплаты в магазины. 
На вход принимает токен пользователя и Map параметров магазина.
Возврашает экземпляр класса RequestPaymentResponse, который содержит ошибку, если таковая произошла, информацию о статусе операции, идентификатор операции, контракт и баланс.

* `processPayment` — метод для подтверждения перевода, полученного при вызове requestPaymentP2P или requestPaymentShop. 
На вход принимает идентификатор запроса.
Возвращает экземпляр класса ProcessPaymentResponse, который содержит информацию о статусе платежа, балнесе после проведения операции и идентификатор платежа.

Примеры использования
---------------------

Для выполнения операций со счетом через API необходимо получить разрешение пользователя, то есть токен. Его можно получить следующими вызовами (к примеру, с доступом на просмотр информации о счете и истории операций):

      YandexMoney ym = new YandexMoneyImpl(Consts.CLIENT_ID);

      // Указываем необходимые для работы приложения права 
      // на доступ к счету пользователя
      Collection<Right> scope = new LinkedList<Right>();
      scope.add(new AccountInfo());
      scope.add(new OperationHistory());   
  
      codeReqUri = ym.authorizeUri(scope, Consts.REDIRECT_URI);    
      response.sendRedirect(codeReqUri);

      // Затем на странице редиректа выполняем обмен временного кода на постоянный токен доступа
      String code = request.getParameter("code");
      ReceiveOAuthTokenResponse resp = ym.receiveOAuthToken(code, Consts.REDIRECT_URI);
      if (resp.isSuccess()) {
        out.println("Токен: " + resp.getAccessToken());
      }

При создании объекта ym ему передается идентификатор приложения, который обычно прописывается в константах приложения (client.Consts в наших примерах). Затем проставляем права scope и делаем вызов полученного URI. 
Чтобы получить информацию о счете пользователя, можно таким же образом создать объект, а затем вызвать метод, передав ему токен пользователя:

      YandexMoney ym = new YandexMoneyImpl(Consts.CLIENT_ID);
      String token = (String) session.getAttribute("token");
      AccountInfoResponse resp = null;
      try {
        resp = ym.accountInfo(token);
      } catch (Exception e) {
        out.println("При выполнении возникла ошибка: " + e.getMessage());
      }

Информация о счете получена. 
Примерно так же обстоят дела и с другими вызовами. Предлагаем вам посмотреть (а может, и запустить) более полные примеры использования библиотеки (`war\ym.war` в архиве с исходниками или на github'е https://github.com/melnikovdv/Java-Yandex.Money-API-SDK). Среди них вы найдете пример оплаты за мобильную связь и небольшой бонус, который позволяет без исопльзования API создать прямую ссылку для перевода денег на другой счет. 

Для успешного запуска примеров из комплекта следует проделать следующее:

* установить (если ранее не был установлен) какой-нибудь application server, например Apache Tomcat (http://tomcat.apache.org/);
* задеплоить веб-архив ym.war (в каталоге war).

Или собрать проект самостоятельно. Для этого:

* зарегистрировать приложение, т.е. получить идентификатор клиента (https://sp-money.yandex.ru/myservices/new.xml) и прописать его в константы примеров (src\client\Consts.java);
* изменить `REDIRECT_URI` (`src\client\Consts.java`), если отличается; 	
* скомпилировать и запустить веб-приложение.
